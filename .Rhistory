mat_map <- c(
"Short (7-31D)" = "Short",
"Ultra-Short (< 7D)" = "Ultra-Short"
)
plot_df <- df %>%
filter(feature_name %in% target_features) %>%
filter(is.finite(feature_value), is.finite(shap_value)) %>%
# Apply the maturity mapping
mutate(maturity_clean = ifelse(maturity %in% names(mat_map),
mat_map[maturity],
as.character(maturity))) %>%
# Group by everything to calculate percentiles per cell
group_by(feature_name, category, maturity_clean) %>%
mutate(percentile = cume_dist(feature_value) * 100) %>%
ungroup() %>%
mutate(
category = factor(category, levels = c("Call", "Put", "ITM Call", "OTM Call", "ITM Put", "OTM Put", "ATM (All)")),
maturity_clean = factor(maturity_clean, levels = c("Ultra-Short", "Short")),
feature_name = factor(feature_name, levels = target_features)
)
# --- 4. Create Decile Points (Tighter 0.5 span) ---
decile_points <- plot_df %>%
group_by(feature_name, category, maturity_clean) %>%
do({
if(n_distinct(.$percentile) > 10) {
tryCatch({
mod <- loess(shap_value ~ percentile, data = ., span = 0.5,
control = loess.control(surface = "direct"))
target_pcts <- seq(0, 100, by = 10)
data.frame(
percentile = target_pcts,
shap_value = predict(mod, newdata = data.frame(percentile = target_pcts))
)
}, error = function(e) data.frame())
} else { data.frame() }
}) %>%
ungroup()
# --- 5. Generate the Plot ---
paper_colors <- c(
"ATM (All)" = "#505679", "ITM Call"  = "#EC9AC0",
"OTM Call"  = "#F5CCDF", "ITM Put"   = "#6A8474",
"OTM Put"   = "#C6D2CA", "Call"      = "#EC9AC0", "Put" = "#6A8474"
)
final_plot <- ggplot(plot_df, aes(x = percentile, y = shap_value, color = category)) +
# Zero baseline
geom_hline(yintercept = 0, linetype = "solid", color = "black", linewidth = 0.4) +
# Bali-style smooth lines (Tighter span)
geom_smooth(method = "loess", se = FALSE, span = 0.5, linewidth = 1.1, na.rm = TRUE) +
# Decile dots
geom_point(data = decile_points, aes(x = percentile, y = shap_value, color = category),
size = 1.5, alpha = 0.8, na.rm = TRUE) +
# THE GRID: Rows = Features, Columns = Maturity
# This puts Ultra-Short on left and Short on right automatically
facet_grid(feature_name ~ maturity_clean, scales = "free_y") +
# Formatting
scale_color_manual(values = paper_colors, name = NULL) +
scale_x_continuous(breaks = c(0, 20, 40, 60, 80, 100), limits = c(0, 100)) +
labs(x = "Percentile", y = expression(SHAP[Impact])) +
# Thesis Theme
theme_bw(base_size = 11) +
theme(
legend.position = "top",
# Remove redundant x-axis labels from internal plots (handled by facet_grid)
panel.grid.major.y = element_line(colour = "grey90", linetype = "dashed"),
panel.grid.major.x = element_blank(),
panel.grid.minor = element_blank(),
# Boxed Header Styling
strip.background = element_rect(fill = "grey95", color = "black"),
strip.text = element_text(face = "bold", size = 10),
panel.border = element_rect(color = "black", fill = NA, linewidth = 0.7),
axis.title.x = element_text(face = "bold", margin = margin(t = 10)),
plot.margin = margin(t = 5, r = 10, b = 10, l = 10)
)
# --- 6. Save and Print ---
# 10 inches height and 8.5 width is standard for a full page in a thesis
ggsave("SHAP_Grid_Thesis.png", final_plot, width = 8.5, height = 10, dpi = 300)
print(final_plot)
# --- 1. Load Libraries ---
library(ggplot2)
library(dplyr)
library(tidyr)
# --- 2. Load the data ---
df <- read.csv("C:/Users/kawah/prettygood/cleanrepo/shap_r_ready_final.csv")
# --- 3. Data Preparation ---
# Filter for your 3 target variables and clean up labels
target_features <- c("reddit_neg_z", "opt_rel_spread_final", "log_mid_t")
# Map the maturity strings from your CSV to the pretty labels
mat_map <- c(
"Short (7-31D)" = "Short",
"Ultra-Short (< 7D)" = "Ultra-Short"
)
plot_df <- df %>%
filter(feature_name %in% target_features) %>%
filter(is.finite(feature_value), is.finite(shap_value)) %>%
# Apply the maturity mapping
mutate(maturity_clean = ifelse(maturity %in% names(mat_map),
mat_map[maturity],
as.character(maturity))) %>%
# Group by everything to calculate percentiles per cell
group_by(feature_name, category, maturity_clean) %>%
mutate(percentile = cume_dist(feature_value) * 100) %>%
ungroup() %>%
mutate(
category = factor(category, levels = c("Call", "Put", "ITM Call", "OTM Call", "ITM Put", "OTM Put", "ATM (All)")),
maturity_clean = factor(maturity_clean, levels = c("Ultra-Short", "Short")),
feature_name = factor(feature_name, levels = target_features)
)
# --- 4. Create Decile Points (Tighter 0.5 span) ---
decile_points <- plot_df %>%
group_by(feature_name, category, maturity_clean) %>%
do({
if(n_distinct(.$percentile) > 10) {
tryCatch({
mod <- loess(shap_value ~ percentile, data = ., span = 0.5,
control = loess.control(surface = "direct"))
target_pcts <- seq(0, 100, by = 10)
data.frame(
percentile = target_pcts,
shap_value = predict(mod, newdata = data.frame(percentile = target_pcts))
)
}, error = function(e) data.frame())
} else { data.frame() }
}) %>%
ungroup()
# --- 5. Generate the Plot ---
paper_colors <- c(
"ATM (All)" = "#505679", "ITM Call"  = "#EC9AC0",
"OTM Call"  = "#F5CCDF", "ITM Put"   = "#6A8474",
"OTM Put"   = "#C6D2CA", "Call"      = "#EC9AC0", "Put" = "#6A8474"
)
final_plot <- ggplot(plot_df, aes(x = percentile, y = shap_value, color = category)) +
# Zero baseline
geom_hline(yintercept = 0, linetype = "solid", color = "black", linewidth = 0.4) +
# Bali-style smooth lines (Tighter span)
geom_smooth(method = "loess", se = FALSE, span = 0.5, linewidth = 1.1, na.rm = TRUE) +
# Decile dots
geom_point(data = decile_points, aes(x = percentile, y = shap_value, color = category),
size = 1.5, alpha = 0.8, na.rm = TRUE) +
# THE GRID: Rows = Features, Columns = Maturity
# This puts Ultra-Short on left and Short on right automatically
facet_grid(feature_name ~ maturity_clean, scales = "free_y") +
# Formatting
scale_color_manual(values = paper_colors, name = NULL) +
scale_x_continuous(breaks = c(0, 20, 40, 60, 80, 100), limits = c(0, 100)) +
labs(x = "Percentile", y = expression(SHAP[Impact])) +
# Thesis Theme
theme_bw(base_size = 11) +
theme(
legend.position = "top",
# Remove redundant x-axis labels from internal plots (handled by facet_grid)
panel.grid.major.y = element_line(colour = "grey90", linetype = "dashed"),
panel.grid.major.x = element_blank(),
panel.grid.minor = element_blank(),
# Boxed Header Styling
strip.background = element_rect(fill = "grey95", color = "black"),
strip.text = element_text(face = "bold", size = 10),
panel.border = element_rect(color = "black", fill = NA, linewidth = 0.7),
axis.title.x = element_text(face = "bold", margin = margin(t = 10)),
plot.margin = margin(t = 5, r = 10, b = 10, l = 10)
)
# --- 6. Save and Print ---
# 10 inches height and 8.5 width is standard for a full page in a thesis
ggsave("SHAP_Grid_Thesis.png", final_plot, width = 8.5, height = 10, dpi = 300)
print(final_plot)
# --- 1. Load Libraries ---
library(ggplot2)
library(dplyr)
library(tidyr)
# --- 2. Load the data ---
df <- read.csv("C:/Users/kawah/prettygood/cleanrepo/shap_r_ready_final.csv")
# --- 3. Data Preparation ---
# Filter for your 3 target variables and clean up labels
target_features <- c("iv", "convexity_proxy", "log1p_spot_reserve_usd")
# Map the maturity strings from your CSV to the pretty labels
mat_map <- c(
"Short (7-31D)" = "Short",
"Ultra-Short (< 7D)" = "Ultra-Short"
)
plot_df <- df %>%
filter(feature_name %in% target_features) %>%
filter(is.finite(feature_value), is.finite(shap_value)) %>%
# Apply the maturity mapping
mutate(maturity_clean = ifelse(maturity %in% names(mat_map),
mat_map[maturity],
as.character(maturity))) %>%
# Group by everything to calculate percentiles per cell
group_by(feature_name, category, maturity_clean) %>%
mutate(percentile = cume_dist(feature_value) * 100) %>%
ungroup() %>%
mutate(
category = factor(category, levels = c("Call", "Put", "ITM Call", "OTM Call", "ITM Put", "OTM Put", "ATM (All)")),
maturity_clean = factor(maturity_clean, levels = c("Ultra-Short", "Short")),
feature_name = factor(feature_name, levels = target_features)
)
# --- 4. Create Decile Points (Tighter 0.5 span) ---
decile_points <- plot_df %>%
group_by(feature_name, category, maturity_clean) %>%
do({
if(n_distinct(.$percentile) > 10) {
tryCatch({
mod <- loess(shap_value ~ percentile, data = ., span = 0.5,
control = loess.control(surface = "direct"))
target_pcts <- seq(0, 100, by = 10)
data.frame(
percentile = target_pcts,
shap_value = predict(mod, newdata = data.frame(percentile = target_pcts))
)
}, error = function(e) data.frame())
} else { data.frame() }
}) %>%
ungroup()
# --- 5. Generate the Plot ---
paper_colors <- c(
"ATM (All)" = "#505679", "ITM Call"  = "#EC9AC0",
"OTM Call"  = "#F5CCDF", "ITM Put"   = "#6A8474",
"OTM Put"   = "#C6D2CA", "Call"      = "#EC9AC0", "Put" = "#6A8474"
)
final_plot <- ggplot(plot_df, aes(x = percentile, y = shap_value, color = category)) +
# Zero baseline
geom_hline(yintercept = 0, linetype = "solid", color = "black", linewidth = 0.4) +
# Bali-style smooth lines (Tighter span)
geom_smooth(method = "loess", se = FALSE, span = 0.5, linewidth = 1.1, na.rm = TRUE) +
# Decile dots
geom_point(data = decile_points, aes(x = percentile, y = shap_value, color = category),
size = 1.5, alpha = 0.8, na.rm = TRUE) +
# THE GRID: Rows = Features, Columns = Maturity
# This puts Ultra-Short on left and Short on right automatically
facet_grid(feature_name ~ maturity_clean, scales = "free_y") +
# Formatting
scale_color_manual(values = paper_colors, name = NULL) +
scale_x_continuous(breaks = c(0, 20, 40, 60, 80, 100), limits = c(0, 100)) +
labs(x = "Percentile", y = expression(SHAP[Impact])) +
# Thesis Theme
theme_bw(base_size = 11) +
theme(
legend.position = "top",
# Remove redundant x-axis labels from internal plots (handled by facet_grid)
panel.grid.major.y = element_line(colour = "grey90", linetype = "dashed"),
panel.grid.major.x = element_blank(),
panel.grid.minor = element_blank(),
# Boxed Header Styling
strip.background = element_rect(fill = "grey95", color = "black"),
strip.text = element_text(face = "bold", size = 10),
panel.border = element_rect(color = "black", fill = NA, linewidth = 0.7),
axis.title.x = element_text(face = "bold", margin = margin(t = 10)),
plot.margin = margin(t = 5, r = 10, b = 10, l = 10)
)
# --- 6. Save and Print ---
# 10 inches height and 8.5 width is standard for a full page in a thesis
ggsave("SHAP_Grid_Thesis.png", final_plot, width = 8.5, height = 10, dpi = 300)
print(final_plot)
# --- 1. Load Libraries ---
library(ggplot2)
library(dplyr)
library(tidyr)
# --- 2. Load the data ---
df <- read.csv("C:/Users/kawah/prettygood/cleanrepo/shap_r_ready_final.csv")
# --- 3. Data Preparation ---
# Filter for your 3 target variables and clean up labels
target_features <- c("futmom_10", "convexity_proxy")
# Map the maturity strings from your CSV to the pretty labels
mat_map <- c(
"Short (7-31D)" = "Short",
"Ultra-Short (< 7D)" = "Ultra-Short"
)
plot_df <- df %>%
filter(feature_name %in% target_features) %>%
filter(is.finite(feature_value), is.finite(shap_value)) %>%
# Apply the maturity mapping
mutate(maturity_clean = ifelse(maturity %in% names(mat_map),
mat_map[maturity],
as.character(maturity))) %>%
# Group by everything to calculate percentiles per cell
group_by(feature_name, category, maturity_clean) %>%
mutate(percentile = cume_dist(feature_value) * 100) %>%
ungroup() %>%
mutate(
category = factor(category, levels = c("Call", "Put", "ITM Call", "OTM Call", "ITM Put", "OTM Put", "ATM (All)")),
maturity_clean = factor(maturity_clean, levels = c("Ultra-Short", "Short")),
feature_name = factor(feature_name, levels = target_features)
)
# --- 4. Create Decile Points (Tighter 0.5 span) ---
decile_points <- plot_df %>%
group_by(feature_name, category, maturity_clean) %>%
do({
if(n_distinct(.$percentile) > 10) {
tryCatch({
mod <- loess(shap_value ~ percentile, data = ., span = 0.5,
control = loess.control(surface = "direct"))
target_pcts <- seq(0, 100, by = 10)
data.frame(
percentile = target_pcts,
shap_value = predict(mod, newdata = data.frame(percentile = target_pcts))
)
}, error = function(e) data.frame())
} else { data.frame() }
}) %>%
ungroup()
# --- 5. Generate the Plot ---
paper_colors <- c(
"ATM (All)" = "#505679", "ITM Call"  = "#EC9AC0",
"OTM Call"  = "#F5CCDF", "ITM Put"   = "#6A8474",
"OTM Put"   = "#C6D2CA", "Call"      = "#EC9AC0", "Put" = "#6A8474"
)
final_plot <- ggplot(plot_df, aes(x = percentile, y = shap_value, color = category)) +
# Zero baseline
geom_hline(yintercept = 0, linetype = "solid", color = "black", linewidth = 0.4) +
# Bali-style smooth lines (Tighter span)
geom_smooth(method = "loess", se = FALSE, span = 0.5, linewidth = 1.1, na.rm = TRUE) +
# Decile dots
geom_point(data = decile_points, aes(x = percentile, y = shap_value, color = category),
size = 1.5, alpha = 0.8, na.rm = TRUE) +
# THE GRID: Rows = Features, Columns = Maturity
# This puts Ultra-Short on left and Short on right automatically
facet_grid(feature_name ~ maturity_clean, scales = "free_y") +
# Formatting
scale_color_manual(values = paper_colors, name = NULL) +
scale_x_continuous(breaks = c(0, 20, 40, 60, 80, 100), limits = c(0, 100)) +
labs(x = "Percentile", y = expression(SHAP[Impact])) +
# Thesis Theme
theme_bw(base_size = 11) +
theme(
legend.position = "top",
# Remove redundant x-axis labels from internal plots (handled by facet_grid)
panel.grid.major.y = element_line(colour = "grey90", linetype = "dashed"),
panel.grid.major.x = element_blank(),
panel.grid.minor = element_blank(),
# Boxed Header Styling
strip.background = element_rect(fill = "grey95", color = "black"),
strip.text = element_text(face = "bold", size = 10),
panel.border = element_rect(color = "black", fill = NA, linewidth = 0.7),
axis.title.x = element_text(face = "bold", margin = margin(t = 10)),
plot.margin = margin(t = 5, r = 10, b = 10, l = 10)
)
# --- 6. Save and Print ---
# 10 inches height and 8.5 width is standard for a full page in a thesis
ggsave("SHAP_Grid_Thesis.png", final_plot, width = 8.5, height = 10, dpi = 300)
print(final_plot)
# --- 1. Load Libraries ---
library(ggplot2)
library(dplyr)
library(tidyr)
# --- 2. Load the data ---
df <- read.csv("C:/Users/kawah/prettygood/cleanrepo/shap_r_ready_final.csv")
# --- 3. Data Preparation ---
# Filter for your 3 target variables and clean up labels
target_features <- c("reddit_neg_z","tau")
# Map the maturity strings from your CSV to the pretty labels
mat_map <- c(
"Short (7-31D)" = "Short",
"Ultra-Short (< 7D)" = "Ultra-Short"
)
plot_df <- df %>%
filter(feature_name %in% target_features) %>%
filter(is.finite(feature_value), is.finite(shap_value)) %>%
# Apply the maturity mapping
mutate(maturity_clean = ifelse(maturity %in% names(mat_map),
mat_map[maturity],
as.character(maturity))) %>%
# Group by everything to calculate percentiles per cell
group_by(feature_name, category, maturity_clean) %>%
mutate(percentile = cume_dist(feature_value) * 100) %>%
ungroup() %>%
mutate(
category = factor(category, levels = c("Call", "Put", "ITM Call", "OTM Call", "ITM Put", "OTM Put", "ATM (All)")),
maturity_clean = factor(maturity_clean, levels = c("Ultra-Short", "Short")),
feature_name = factor(feature_name, levels = target_features)
)
# --- 4. Create Decile Points (Tighter 0.5 span) ---
decile_points <- plot_df %>%
group_by(feature_name, category, maturity_clean) %>%
do({
if(n_distinct(.$percentile) > 10) {
tryCatch({
mod <- loess(shap_value ~ percentile, data = ., span = 0.5,
control = loess.control(surface = "direct"))
target_pcts <- seq(0, 100, by = 10)
data.frame(
percentile = target_pcts,
shap_value = predict(mod, newdata = data.frame(percentile = target_pcts))
)
}, error = function(e) data.frame())
} else { data.frame() }
}) %>%
ungroup()
# --- 5. Generate the Plot ---
paper_colors <- c(
"ATM (All)" = "#505679", "ITM Call"  = "#EC9AC0",
"OTM Call"  = "#F5CCDF", "ITM Put"   = "#6A8474",
"OTM Put"   = "#C6D2CA", "Call"      = "#EC9AC0", "Put" = "#6A8474"
)
final_plot <- ggplot(plot_df, aes(x = percentile, y = shap_value, color = category)) +
# Zero baseline
geom_hline(yintercept = 0, linetype = "solid", color = "black", linewidth = 0.4) +
# Bali-style smooth lines (Tighter span)
geom_smooth(method = "loess", se = FALSE, span = 0.5, linewidth = 1.1, na.rm = TRUE) +
# Decile dots
geom_point(data = decile_points, aes(x = percentile, y = shap_value, color = category),
size = 1.5, alpha = 0.8, na.rm = TRUE) +
# THE GRID: Rows = Features, Columns = Maturity
# This puts Ultra-Short on left and Short on right automatically
facet_grid(feature_name ~ maturity_clean, scales = "free_y") +
# Formatting
scale_color_manual(values = paper_colors, name = NULL) +
scale_x_continuous(breaks = c(0, 20, 40, 60, 80, 100), limits = c(0, 100)) +
labs(x = "Percentile", y = expression(SHAP[Impact])) +
# Thesis Theme
theme_bw(base_size = 11) +
theme(
legend.position = "top",
# Remove redundant x-axis labels from internal plots (handled by facet_grid)
panel.grid.major.y = element_line(colour = "grey90", linetype = "dashed"),
panel.grid.major.x = element_blank(),
panel.grid.minor = element_blank(),
# Boxed Header Styling
strip.background = element_rect(fill = "grey95", color = "black"),
strip.text = element_text(face = "bold", size = 10),
panel.border = element_rect(color = "black", fill = NA, linewidth = 0.7),
axis.title.x = element_text(face = "bold", margin = margin(t = 10)),
plot.margin = margin(t = 5, r = 10, b = 10, l = 10)
)
# --- 6. Save and Print ---
# 10 inches height and 8.5 width is standard for a full page in a thesis
ggsave("SHAP_Grid_Thesis.png", final_plot, width = 8.5, height = 10, dpi = 300)
print(final_plot)
# --- 1. Load Libraries ---
library(ggplot2)
library(dplyr)
library(tidyr)
# --- 2. Load the data ---
df <- read.csv("C:/Users/kawah/prettygood/cleanrepo/shap_r_ready_final.csv")
# --- 3. Data Preparation ---
# Filter for your 3 target variables and clean up labels
target_features <- c("opt_rel_spread_final","log1p_spot_reserve_usd")
# Map the maturity strings from your CSV to the pretty labels
mat_map <- c(
"Short (7-31D)" = "Short",
"Ultra-Short (< 7D)" = "Ultra-Short"
)
plot_df <- df %>%
filter(feature_name %in% target_features) %>%
filter(is.finite(feature_value), is.finite(shap_value)) %>%
# Apply the maturity mapping
mutate(maturity_clean = ifelse(maturity %in% names(mat_map),
mat_map[maturity],
as.character(maturity))) %>%
# Group by everything to calculate percentiles per cell
group_by(feature_name, category, maturity_clean) %>%
mutate(percentile = cume_dist(feature_value) * 100) %>%
ungroup() %>%
mutate(
category = factor(category, levels = c("Call", "Put", "ITM Call", "OTM Call", "ITM Put", "OTM Put", "ATM (All)")),
maturity_clean = factor(maturity_clean, levels = c("Ultra-Short", "Short")),
feature_name = factor(feature_name, levels = target_features)
)
# --- 4. Create Decile Points (Tighter 0.5 span) ---
decile_points <- plot_df %>%
group_by(feature_name, category, maturity_clean) %>%
do({
if(n_distinct(.$percentile) > 10) {
tryCatch({
mod <- loess(shap_value ~ percentile, data = ., span = 0.5,
control = loess.control(surface = "direct"))
target_pcts <- seq(0, 100, by = 10)
data.frame(
percentile = target_pcts,
shap_value = predict(mod, newdata = data.frame(percentile = target_pcts))
)
}, error = function(e) data.frame())
} else { data.frame() }
}) %>%
ungroup()
# --- 5. Generate the Plot ---
paper_colors <- c(
"ATM (All)" = "#505679", "ITM Call"  = "#EC9AC0",
"OTM Call"  = "#F5CCDF", "ITM Put"   = "#6A8474",
"OTM Put"   = "#C6D2CA", "Call"      = "#EC9AC0", "Put" = "#6A8474"
)
final_plot <- ggplot(plot_df, aes(x = percentile, y = shap_value, color = category)) +
# Zero baseline
geom_hline(yintercept = 0, linetype = "solid", color = "black", linewidth = 0.4) +
# Bali-style smooth lines (Tighter span)
geom_smooth(method = "loess", se = FALSE, span = 0.5, linewidth = 1.1, na.rm = TRUE) +
# Decile dots
geom_point(data = decile_points, aes(x = percentile, y = shap_value, color = category),
size = 1.5, alpha = 0.8, na.rm = TRUE) +
# THE GRID: Rows = Features, Columns = Maturity
# This puts Ultra-Short on left and Short on right automatically
facet_grid(feature_name ~ maturity_clean, scales = "free_y") +
# Formatting
scale_color_manual(values = paper_colors, name = NULL) +
scale_x_continuous(breaks = c(0, 20, 40, 60, 80, 100), limits = c(0, 100)) +
labs(x = "Percentile", y = expression(SHAP[Impact])) +
# Thesis Theme
theme_bw(base_size = 11) +
theme(
legend.position = "top",
# Remove redundant x-axis labels from internal plots (handled by facet_grid)
panel.grid.major.y = element_line(colour = "grey90", linetype = "dashed"),
panel.grid.major.x = element_blank(),
panel.grid.minor = element_blank(),
# Boxed Header Styling
strip.background = element_rect(fill = "grey95", color = "black"),
strip.text = element_text(face = "bold", size = 10),
panel.border = element_rect(color = "black", fill = NA, linewidth = 0.7),
axis.title.x = element_text(face = "bold", margin = margin(t = 10)),
plot.margin = margin(t = 5, r = 10, b = 10, l = 10)
)
# --- 6. Save and Print ---
# 10 inches height and 8.5 width is standard for a full page in a thesis
ggsave("SHAP_Grid_Thesis.png", final_plot, width = 8.5, height = 10, dpi = 300)
print(final_plot)
